<!DOCTYPE html>
<html>
<head>
    <title>视频接收端</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/receiver.css') }}">
</head>
<body>
    <div class="container">
        <div class="video-container">
            <canvas id="outputCanvas" width="640" height="480"></canvas>
        </div>
        
        <div class="stats-container">
            <div class="stats-item">
                <div class="stats-label">连接状态</div>
                <div>
                    <span class="status-indicator disconnected" id="connectionStatus"></span>
                    <span id="statusText">未连接</span>
                </div>
            </div>
            
            <div class="stats-item">
                <div class="stats-label">实时带宽</div>
                <div class="stats-value" id="bandwidth">0 KB/s</div>
            </div>
            
            <div class="stats-item">
                <div class="stats-label">帧率</div>
                <div class="stats-value" id="fps">0 FPS</div>
            </div>
            
            <div class="stats-item">
                <div class="stats-label">延迟</div>
                <div class="stats-value" id="latency">0 ms</div>
            </div>
            
            <div class="stats-item">
                <div class="stats-label">总传输数据</div>
                <div class="stats-value" id="totalData">0 MB</div>
            </div>
            
            <div id="bandwidthChart"></div>
        </div>
    </div>

    <div class="room-info">
        <h3>房间ID: {{ room_id }}</h3>
    </div>

    <script src="{{ url_for('static', filename='js/sceneRenderer.js') }}"></script>
    <script src="{{ url_for('static', filename='js/statsManager.js') }}"></script>
    <script>
        // 初始化
        const canvas = document.getElementById('outputCanvas');
        const renderer = new SceneRenderer(canvas);
        const stats = new StatsManager();
        const socket = io();

        // Socket.IO 事件处理
        socket.on('connect', () => {
            console.log('WebSocket 已连接');
            document.getElementById('connectionStatus').className = 'status-indicator connected';
            document.getElementById('statusText').textContent = '已连接';
            
            const urlParams = new URLSearchParams(window.location.search);
            const roomId = urlParams.get('room');
            if (roomId) {
                console.log('尝试加入房间:', roomId);
                socket.emit('join_room', { room: roomId, role: 'receiver' });
            } else {
                console.error('URL中未找到房间ID');
                renderer.showMessage('URL中未找到房间ID', true);
            }
        });

        socket.on('disconnect', () => {
            console.log('WebSocket 已断开');
            document.getElementById('connectionStatus').className = 'status-indicator disconnected';
            document.getElementById('statusText').textContent = '未连接';
            renderer.showMessage('连接已断开', true);
        });

        socket.on('connect_error', (error) => {
            console.error('连接错误:', error);
            document.getElementById('connectionStatus').className = 'status-indicator disconnected';
            document.getElementById('statusText').textContent = '连接错误';
            renderer.showMessage('连接错误: ' + error.message, true);
        });

        socket.on('room_joined', (data) => {
            console.log('成功加入房间:', data);
            socket.emit('get_initial_frame', { room: data.room });
        });

        socket.on('initial_frame', async (data) => {
            try {
                await renderer.setInitialFrame(data.image);
                stats.updateStats(data.image.length);
            } catch (error) {
                console.error('设置初始帧失败:', error);
                renderer.showMessage('加载初始帧失败', true);
            }
        });

        socket.on('pose_data', (data) => {
            try {
                if (!data || !data.data) return;
                renderer.updatePose(data.data);
                stats.updateStats(JSON.stringify(data).length);
            } catch (error) {
                console.error('处理姿态数据错误:', error);
            }
        });

        socket.on('waiting_initial_frame', () => {
            renderer.showMessage('等待初始帧...');
        });

        socket.on('error', (data) => {
            console.error('收到错误:', data.message);
            renderer.showMessage(data.message, true);
        });
    </script>
</body>
</html> 